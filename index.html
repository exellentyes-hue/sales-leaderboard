<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sales Leaderboard ‚Äî FTD</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1020;--panel:#121933;--muted:#aab1c3;--text:#e8ecf8;--accent:#7dd3fc;--good:#34d399;--warn:#f59e0b;--bad:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;background:radial-gradient(1200px 600px at 80% -10%, #1b2652 0%, rgba(27,38,82,0) 70%), var(--bg);color:var(--text);}

    .container{max-width:1100px;margin:0 auto;padding:24px}
    header{display:flex;gap:16px;align-items:center;justify-content:center;margin-bottom:18px}
    .title{
      font-weight:700;
      font-size:36px;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .pill{font-size:12px;background:rgba(125,211,252,.15);border:1px solid rgba(125,211,252,.35);padding:6px 10px;border-radius:999px;color:var(--accent)}
    
    /* –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫ –∫–æ–º–∞–Ω–¥ –≤ —Ä—è–¥ */
    .grid {
      display: flex;
      flex-wrap: wrap; /* –í—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ —Ä—è–¥ —Å –ø–µ—Ä–µ–Ω–æ—Å–æ–º */
      justify-content: space-between; /* –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫ –ø–æ –≤—Å–µ–π —à–∏—Ä–∏–Ω–µ */
      gap: 16px;
    }

    .card {
      background: linear-gradient(180deg, rgba(255, 255, 255, .02), rgba(255, 255, 255, .00));
      border: 1px solid rgba(255, 255, 255, .08);
      backdrop-filter: blur(6px);
      border-radius: 18px;
      padding: 32px 28px; /* –£–≤–µ–ª–∏—á–µ–Ω—ã –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã */
      box-shadow: 0 10px 30px rgba(0, 0, 0, .25);
      position: relative;
      flex: 1; /* –ö–∞—Ä—Ç–æ—á–∫–∏ –±—É–¥—É—Ç –∑–∞–Ω–∏–º–∞—Ç—å –≤—Å—é –¥–æ—Å—Ç—É–ø–Ω—É—é —à–∏—Ä–∏–Ω—É */
      min-width: 320px; /* –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ */
      height: auto;
    }

    .card h2 {
      margin: 4px 0 10px 0;
      font-size: 24px; /* –£–≤–µ–ª–∏—á–µ–Ω —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ */
      font-weight: 700;
      color: #e2e8f0;
    }

    .list {
      display: flex;
      flex-direction: column;
    }

    .row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 12px; /* –£–≤–µ–ª–∏—á–µ–Ω—ã –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã */
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, .06);
      background: rgba(255, 255, 255, .02);
      margin-bottom: 8px;
    }

    .row .name {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      font-size: 16px; /* –£–≤–µ–ª–∏—á–µ–Ω —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ */
    }

    .badge {
      font-size: 14px; /* –£–≤–µ–ª–∏—á–µ–Ω —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ */
      color: #e8ecf8;
      background: #0f172a;
      border: 1px solid rgba(255, 255, 255, .08);
      padding: 6px 10px;
      border-radius: 999px;
    }

    .badge.first {
      color: gold; /* –ó–æ–ª–æ—Ç–æ–π —Ü–≤–µ—Ç –¥–ª—è –ø–µ—Ä–≤–æ–π —Ü–∏—Ñ—Ä—ã */
    }

    .row:first-child {
      background-color: gold; /* –ó–æ–ª–æ—Ç–æ–π —Ñ–æ–Ω –¥–ª—è –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏ */
      color: black; /* –ß—ë—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç */
    }

    .row:nth-child(2) {
      background-color: silver; /* –°–µ—Ä–µ–±—Ä—è–Ω—ã–π —Ñ–æ–Ω –¥–ª—è –≤—Ç–æ—Ä–æ–π —Å—Ç—Ä–æ–∫–∏ */
      color: black; /* –ß—ë—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç */
    }

    .row:nth-child(3) {
      background-color: #cd7f32; /* –ë—Ä–æ–Ω–∑–æ–≤—ã–π —Ñ–æ–Ω –¥–ª—è —Ç—Ä–µ—Ç—å–µ–π —Å—Ç—Ä–æ–∫–∏ */
      color: black; /* –ß—ë—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç */
    }

    .ftd {
      font-weight: 700;
      font-size: 18px; /* –£–≤–µ–ª–∏—á–µ–Ω —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ */
    }

    .ftd.up {
      color: var(--good);
    }

    .footer {
      opacity: .75;
      font-size: 12px;
      margin-top: 10px;
    }

    .toolbar {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    button {
      cursor: pointer;
      background: #1e293b;
      color: #e2e8f0;
      border: 1px solid rgba(255, 255, 255, .12);
      border-radius: 10px;
      padding: 8px 10px;
      font-weight: 600;
    }

    button:hover {
      background: #243046;
    }

    .hint {
      font-size: 12px;
      color: var(--muted);
    }

    /* ===== –û–≤–µ—Ä–ª–µ–π —Å —ç—Ñ—Ñ–µ–∫—Ç–∞–º–∏ ===== */
    #overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 72px;
      font-weight: 900;
      color: var(--accent);
      z-index: 9999;
      text-align: center;
      text-transform: uppercase;
      opacity: 0;
      pointer-events: none;
    }

    #overlay.show {
      animation: zoomGlow 2s ease forwards;
    }

    @keyframes zoomGlow {
      0% {
        transform: scale(0.2);
        opacity: 0;
        text-shadow: 0 0 0px var(--accent);
      }
      40% {
        transform: scale(1.3);
        opacity: 1;
        text-shadow: 0 0 20px var(--accent), 0 0 40px #0ff;
      }
      70% {
        transform: scale(1);
        opacity: 1;
        text-shadow: 0 0 25px #fff, 0 0 50px var(--accent);
      }
      100% {
        transform: scale(1);
        opacity: 0;
        text-shadow: 0 0 0px transparent;
      }
    }

    #overlay span {
      background: linear-gradient(270deg, #7dd3fc, #34d399, #f59e0b, #ef4444, #7dd3fc);
      background-size: 1000% 1000%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: gradientMove 3s linear infinite;
    }

    @keyframes gradientMove {
      0% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
      100% {
        background-position: 0% 50%;
      }
    }

    /* Canvas –¥–ª—è –¥–µ–Ω–µ–≥ */
    #money-canvas {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 5000;
    }

    /* –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—â–µ–≥–æ FTD */
    .total-ftd {
      font-size: 16px;
      font-weight: 700;
      color: var(--accent);
      position: absolute;
      right: 10px;
      top: 10px;
    }
  </style>
</head>
<body>
  <canvas id="confetti-canvas"></canvas>
  <canvas id="money-canvas"></canvas>
  <div class="container">
    <header>
      <div class="title">
        <span>üèÜ</span> Sales Leaderboard <span>üèÜ</span>
      </div>
    </header>

    <div id="grid" class="grid"></div>
  </div>

  <div id="overlay"><span></span></div>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.0/dist/confetti.browser.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.0/dist/confetti.browser.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.0/dist/confetti.browser.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.0/dist/confetti.browser.min.js"></script>

<script>
  const CONFIG = {
    SHEET_ID: "1mErOW57MrU_fhQnRsI1ZSldw7dpd7lrl4yu7EgMpx1o",
    API_KEY:  "AIzaSyCFS9Tse6vuK2O3PK4PyS0DDgRIzbC1F2E",
    RANGE:    "Sheet1!A:C",
    POLL_MS:  5000
  };

  // ---------- –ê–£–î–ò–û ----------
  const SOUND_SRC = 'videoplayback.mp3'; // –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –ø–æ–ª–Ω—ã–π URL –ø—Ä–∏ GitHub Pages
  const SOUND_POOL_SIZE = 4;
  const soundPool = Array.from({length: SOUND_POOL_SIZE}, () => {
    const a = new Audio(SOUND_SRC);
    a.preload = 'auto';
    a.playsInline = true;
    a.volume = 0.9;
    return a;
  });

  let soundEnabled = false;

  function unlockAudioOnce() {
    Promise.allSettled(soundPool.map(a => a.play().then(() => {
      a.pause();
      a.currentTime = 0;
    }))).finally(() => {
      soundEnabled = true;
      console.log('[FTD] Audio unlocked');
      updateToolbar();
    });
  }

  function playFTDSound() {
    if (!soundEnabled) return;
    const a = soundPool.find(x => x.paused) || soundPool[0].cloneNode(true);
    a.currentTime = 0;
    a.play().catch(err => console.warn('[FTD] play error:', err));
  }

  // –í—Å—Ç–∞–≤–∏–º —Ç—É–ª–±–∞—Ä —Å –æ–¥–Ω–æ–π –∫–Ω–æ–ø–∫–æ–π
  function injectToolbar() {
    const header = document.querySelector('header');
    if (!header) return;
    const bar = document.createElement('div');
    bar.className = 'toolbar';
    bar.style.marginLeft = '12px';

    const btnEnable = document.createElement('button');
    btnEnable.id = 'btn-audio';
    btnEnable.textContent = 'üîî –í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫';
    btnEnable.title = '–†–∞–∑—Ä–µ—à–∏—Ç–µ –∑–≤—É–∫ –æ–¥–Ω–∏–º –∫–ª–∏–∫–æ–º';
    btnEnable.addEventListener('click', unlockAudioOnce);

    bar.appendChild(btnEnable);
    header.appendChild(bar);

    document.addEventListener('pointerdown', function once() {
      if (!soundEnabled) unlockAudioOnce();
      document.removeEventListener('pointerdown', once);
    }, { once: true });
  }

  function updateToolbar() {
    const btn = document.getElementById('btn-audio');
    if (btn) btn.textContent = soundEnabled ? 'üîä –ó–≤—É–∫ –∞–∫—Ç–∏–≤–µ–Ω' : 'üîî –í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫';
  }

  // ---------- –í–ò–ó–£–ê–õ ----------
  function makeConfettiBurst() {
    const duration = 1200;
    const end = Date.now() + duration;
    (function frame() {
      confetti({ particleCount: 3, angle: 60, spread: 65, origin: { x: 0 }, scalar: 1.2 });
      confetti({ particleCount: 3, angle: 120, spread: 65, origin: { x: 1 }, scalar: 1.2 });
      if (Date.now() < end) requestAnimationFrame(frame);
    })();
  }

  function makeMoneyRain() {
    const canvas = document.getElementById("money-canvas");
    const ctx = canvas.getContext("2d");
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.src = "https://upload.wikimedia.org/wikipedia/commons/1/1a/USA_100_Dollar_Bill_Series2009_Obverse.png";

    const bills = [];
    const count = 40;
    const fallDuration = 8000;

    for (let i = 0; i < count; i++) {
      bills.push({
        x: Math.random() * canvas.width,
        y: -100,
        rotation: Math.random() * 360,
        rotationSpeed: (Math.random() - 0.5) * 10,
        size: 120 + Math.random() * 60,
        startTime: Date.now(),
        delay: Math.random() * 2000,
        waveOffset: Math.random() * 1000 - 500,
      });
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      bills.forEach(b => {
        const elapsedTime = Date.now() - b.startTime - b.delay;
        const fallProgress = Math.min(Math.max(elapsedTime / fallDuration, 0), 1);
        const yPosition = b.y + fallProgress * (canvas.height + 100);
        const waveMovement = Math.sin(fallProgress * Math.PI * 2 + b.waveOffset) * 150;
        const xPosition = b.x + waveMovement;

        ctx.save();
        ctx.translate(xPosition, yPosition);
        ctx.rotate((b.rotation * Math.PI) / 180);
        ctx.drawImage(img, -b.size / 2, -b.size / 4, b.size, b.size / 2);
        ctx.restore();

        b.rotation += b.rotationSpeed;
      });

      if (bills.some(b => Date.now() - b.startTime - b.delay < fallDuration)) {
        requestAnimationFrame(draw);
      }
    }

    img.onload = draw;
  }

  function showOverlay(name, ftd) {
    const overlay = document.getElementById('overlay');
    const span = overlay.querySelector("span");
    span.textContent = `${name}: ${ftd} üöÄ`;
    overlay.classList.remove("show");
    void overlay.offsetWidth;
    overlay.classList.add("show");
    setTimeout(() => overlay.classList.remove("show"), 2500);
  }

  // ---------- –£–¢–ò–õ–° ----------
  const prevByKey = new Map();

  function normalizeKey(team, stage) {
    return `${String(team||'').trim().toLowerCase()}|${String(stage||'').trim().toLowerCase()}`;
  }

  function toNum(x) {
    if (typeof x === 'number') return x;
    const s = String(x ?? '').replace(/\s+/g, '').replace(',', '.');
    const n = parseFloat(s);
    return Number.isFinite(n) ? n : 0;
  }

  function groupByTeam(rows){
    const teams = {};
    rows.forEach(r => {
      if(!teams[r.team]) teams[r.team] = [];
      teams[r.team].push(r);
    });
    return teams;
  }

  function render(rows){
    const grid = document.getElementById('grid');
    grid.innerHTML = '';
    const teams = groupByTeam(rows);
    const teamNames = Object.keys(teams).sort();

    teamNames.forEach(team => {
      const card = document.createElement('div');
      card.className = 'card';
      const h2 = document.createElement('h2');
      h2.textContent = team;
      card.appendChild(h2);

      const totalFTD = teams[team].reduce((sum, row) => sum + row.ftd, 0);
      const totalFTDElement = document.createElement('div');
      totalFTDElement.className = 'total-ftd';
      totalFTDElement.textContent = `FTD: ${totalFTD}`;
      card.appendChild(totalFTDElement);

      const list = document.createElement('div');
      list.className = 'list';

      let counter = 1;

      teams[team]
        .sort((a,b) => (b.ftd || 0) - (a.ftd || 0))
        .forEach((row, index) => {
          const li = document.createElement('div');
          li.className = 'row';

          const left = document.createElement('div');
          left.className = 'name';
          const badge = document.createElement('span');
          badge.className = 'badge';

          if (index === 0) badge.classList.add('first');
          badge.textContent = counter;

          const nm = document.createElement('span');
          nm.textContent = row.stage;

          left.appendChild(badge);
          left.appendChild(nm);

          const right = document.createElement('div');
          right.className = 'ftd' + (row._up ? ' up' : '');
          right.textContent = row.ftd;

          li.appendChild(left);
          li.appendChild(right);
          list.appendChild(li);

          counter++;
        });

      card.appendChild(list);
      grid.appendChild(card);
    });
  }

  function toObjects(values){
    const [header, ...rows] = values;
    const idx = {
      team: header.findIndex(h => /team/i.test(h)),
      stage: header.findIndex(h => /stage/i.test(h)),
      ftd: header.findIndex(h => /ftd/i.test(h))
    };

    const out = rows.map(r => ({
      team: r[idx.team] || '‚Äî',
      stage: r[idx.stage] || '‚Äî',
      ftd: toNum(r[idx.ftd])
    }));

    out.forEach(o => {
      const key = normalizeKey(o.team, o.stage);
      const prev = prevByKey.get(key);
      if (prev != null && o.ftd > prev) {
        o._up = true;
        makeConfettiBurst();
        makeMoneyRain();
        playFTDSound();
        showOverlay(o.stage, o.ftd);
      } else {
        o._up = false;
      }
      prevByKey.set(key, o.ftd);
    });

    return out;
  }

  async function fetchFromSheets(){
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${encodeURIComponent(CONFIG.RANGE)}?key=${CONFIG.API_KEY}`;
    const res = await fetch(url);
    if(!res.ok) throw new Error('Google Sheets API error');
    const json = await res.json();
    return json.values;
  }

  async function load(){
    try {
      const values = await fetchFromSheets();
      const rows = toObjects(values);
      render(rows);
    } catch (e) {
      console.warn('[FTD] Sheets error, using sample:', e);
      const sample = [
        ['Team','Stage','FTD'],
        ['Team Alpha','–ò–≤–∞–Ω',5],
        ['Team Alpha','–ê–Ω–Ω–∞',7],
        ['Team Beta','–ü—ë—Ç—Ä',4],
        ['Team Beta','–û–ª—å–≥–∞',8]
      ];
      const rows = toObjects(sample);
      render(rows);
    }
  }

  injectToolbar();
  load();
  setInterval(load, CONFIG.POLL_MS);
</script>
</body>
</html>
