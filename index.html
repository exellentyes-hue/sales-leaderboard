<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sales Leaderboard ‚Äî FTD</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1020;--panel:#121933;--muted:#aab1c3;--text:#e8ecf8;--accent:#7dd3fc;--good:#34d399;--warn:#f59e0b;--bad:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;background:radial-gradient(1200px 600px at 80% -10%, #1b2652 0%, rgba(27,38,82,0) 70%), var(--bg);color:var(--text);}

    .container{max-width:1100px;margin:0 auto;padding:24px}
    header{display:flex;gap:16px;align-items:center;justify-content:center;margin-bottom:18px}
    .title{
      font-weight:700;
      font-size:36px;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .pill{font-size:12px;background:rgba(125,211,252,.15);border:1px solid rgba(125,211,252,.35);padding:6px 10px;border-radius:999px;color:var(--accent)}
    .grid{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:16px}
    @media(min-width:720px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00));border:1px solid rgba(255,255,255,.08);backdrop-filter: blur(6px);border-radius:18px;padding:16px 14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .card h2{margin:4px 0 10px 0;font-size:18px;font-weight:700;color:#e2e8f0}
    .list{display:flex;flex-direction:column}
    .row{display:flex;align-items:center;justify-content:space-between;padding:10px 8px;border-radius:12px;border:1px solid rgba(255,255,255,.06);background:rgba(255,255,255,.02);margin-bottom:8px}
    .row .name{display:flex;align-items:center;gap:10px;font-weight:600}
    .badge{font-size:11px;color:#cbd5e1;background:#0f172a;border:1px solid rgba(255,255,255,.08);padding:4px 8px;border-radius:999px}
    .ftd{font-weight:700}
    .ftd.up{color:var(--good)}
    .first-place-row {
      background-color: #FFD700;  /* –∑–æ–ª–æ—Ç–æ–π —Ñ–æ–Ω */
      color: #FFD700;  /* –∑–æ–ª–æ—Ç—ã–µ –±—É–∫–≤—ã */
    }
    .footer{opacity:.75;font-size:12px;margin-top:10px}
    .toolbar{display:flex;gap:8px;align-items:center}
    button{cursor:pointer;background:#1e293b;color:#e2e8f0;border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:8px 10px;font-weight:600}
    button:hover{background:#243046}
    .hint{font-size:12px;color:var(--muted)}

    /* ===== –û–≤–µ—Ä–ª–µ–π —Å —ç—Ñ—Ñ–µ–∫—Ç–∞–º–∏ ===== */
    #overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 72px;
      font-weight: 900;
      color: var(--accent);
      z-index: 9999;
      text-align: center;
      text-transform: uppercase;
      opacity: 0;
      pointer-events: none;
    }
    #overlay.show {
      animation: zoomGlow 2s ease forwards;
    }

    @keyframes zoomGlow {
      0% { transform: scale(0.2); opacity: 0; text-shadow: 0 0 0px var(--accent); }
      40% { transform: scale(1.3); opacity: 1; text-shadow: 0 0 20px var(--accent), 0 0 40px #0ff; }
      70% { transform: scale(1); opacity: 1; text-shadow: 0 0 25px #fff, 0 0 50px var(--accent); }
      100% { transform: scale(1); opacity: 0; text-shadow: 0 0 0px transparent; }
    }

    #overlay span {
      background: linear-gradient(270deg, #7dd3fc, #34d399, #f59e0b, #ef4444, #7dd3fc);
      background-size: 1000% 1000%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: gradientMove 3s linear infinite;
    }

    @keyframes gradientMove {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* Canvas –¥–ª—è –¥–µ–Ω–µ–≥ */
    #money-canvas {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 5000;
    }
  </style>
</head>
<body>
  <canvas id="confetti-canvas"></canvas>
  <canvas id="money-canvas"></canvas>
  <div class="container">
    <header>
      <div class="title">
        <span>üèÜ</span> Sales Leaderboard <span>üèÜ</span>
      </div>
    </header>

    <div id="grid" class="grid"></div>
  </div>

  <div id="overlay"><span></span></div>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.0/dist/confetti.browser.min.js"></script>

  <script>
  const CONFIG = {
    SHEET_ID: "1mErOW57MrU_fhQnRsI1ZSldw7dpd7lrl4yu7EgMpx1o",
    API_KEY:  "AIzaSyCFS9Tse6vuK2O3PK4PyS0DDgRIzbC1F2E",
    RANGE:    "Sheet1!A:C",
    POLL_MS:  5000
  };

  const statusEl = document.getElementById('status');
  let prevByStage = new Map();

  function makeConfettiBurst() {
    const duration = 1200;
    const end = Date.now() + duration;
    (function frame() {
      confetti({ particleCount: 3, angle: 60, spread: 65, origin: { x: 0 }, scalar: 1.2 });
      confetti({ particleCount: 3, angle: 120, spread: 65, origin: { x: 1 }, scalar: 1.2 });
      if (Date.now() < end) requestAnimationFrame(frame);
    })();
  }

  function makeMoneyRain() {
    const canvas = document.getElementById("money-canvas");
    const ctx = canvas.getContext("2d");
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    const img = new Image();
    img.src = "https://upload.wikimedia.org/wikipedia/commons/1/1a/USA_100_Dollar_Bill_Series2009_Obverse.png";

    const bills = [];
    const count = 20;
    for (let i = 0; i < count; i++) {
      bills.push({
        x: Math.random() * canvas.width,
        y: -100,
        speed: 2 + Math.random() * 3,
        rotation: Math.random() * 360,
        rotationSpeed: (Math.random() - 0.5) * 10,
        size: 120 + Math.random() * 60
      });
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      bills.forEach(b => {
        ctx.save();
        ctx.translate(b.x, b.y);
        ctx.rotate((b.rotation * Math.PI) / 180);
        ctx.drawImage(img, -b.size / 2, -b.size / 4, b.size, b.size/2);
        ctx.restore();

        b.y += b.speed;
        b.rotation += b.rotationSpeed;
      });

      if (bills.some(b => b.y < canvas.height + 100)) {
        requestAnimationFrame(draw);
      }
    }

    img.onload = draw;
  }

  function showOverlay(name, ftd) {
    const overlay = document.getElementById('overlay');
    const span = overlay.querySelector("span");
    span.textContent = `${name}: ${ftd} üöÄ`;
    overlay.classList.remove("show");
    void overlay.offsetWidth;
    overlay.classList.add("show");
    setTimeout(() => {
      overlay.classList.remove("show");
    }, 2500);
  }

  function groupByTeam(rows){
    const teams = {};
    rows.forEach(r => {
      if(!teams[r.team]) teams[r.team] = [];
      teams[r.team].push(r);
    });
    return teams;
  }

  function render(rows) {
    const grid = document.getElementById('grid');
    grid.innerHTML = '';
    const teams = groupByTeam(rows);
    const teamNames = Object.keys(teams).sort();

    teamNames.forEach(team => {
      const card = document.createElement('div');
      card.className = 'card';
      const h2 = document.createElement('h2');
      h2.textContent = team;
      card.appendChild(h2);

      const list = document.createElement('div');
      list.className = 'list';

      let counter = 1; // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—á–µ—Ç—á–∏–∫

      teams[team]
        .sort((a,b) => (b.ftd || 0) - (a.ftd || 0))
        .forEach((row, index) => {
          const li = document.createElement('div');
          li.className = 'row';

          // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –º–µ—Å—Ç–∞ –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è –≤—Å–µ–π —Å—Ç—Ä–æ–∫–∏
          if (index === 0) {
            li.classList.add('first-place-row');  // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –≤—Å—é —Å—Ç—Ä–æ–∫—É
          }

          const left = document.createElement('div');
          left.className = 'name';
          const badge = document.createElement('span');
          badge.className = 'badge';
          badge.textContent = counter; // –í—ã–≤–æ–¥–∏–º –Ω–æ–º–µ—Ä
          const nm = document.createElement('span');
          nm.textContent = row.stage;
          left.appendChild(badge);
          left.appendChild(nm);

          const right = document.createElement('div');
          right.className = 'ftd' + (row._up ? ' up' : '');
          right.textContent = row.ftd;

          li.appendChild(left);
          li.appendChild(right);
          list.appendChild(li);

          counter++; // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞
        });

      card.appendChild(list);
      grid.appendChild(card);
    });
  }

  function toObjects(values) {
    const [header, ...rows] = values;
    const idx = {
      team: header.findIndex(h => /team/i.test(h)),
      stage: header.findIndex(h => /stage/i.test(h)),
      ftd: header.findIndex(h => /ftd/i.test(h))
    };
    const out = rows.map(r => ({
      team: r[idx.team] || '‚Äî',
      stage: r[idx.stage] || '‚Äî',
      ftd: Number(r[idx.ftd] ?? 0)
    }));

    out.forEach(o => {
      const prev = prevByStage.get(o.stage);
      if (prev != null && o.ftd > prev) {
        o._up = true;
        makeConfettiBurst();
        makeMoneyRain();
        showOverlay(o.stage, o.ftd);
      } else {
        o._up = false;
      }
    });

    out.forEach(o => prevByStage.set(o.stage, o.ftd));
    return out;
  }

  async function fetchFromSheets() {
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${encodeURIComponent(CONFIG.RANGE)}?key=${CONFIG.API_KEY}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error('Google Sheets API error');
    const json = await res.json();
    return json.values;
  }

  async function load() {
    try {
      const values = await fetchFromSheets();
      const rows = toObjects(values);
      render(rows);
    } catch (e) {
      console.warn(e);
      const sample = [
        ['Team','Stage','FTD'],
        ['Team Alpha','–ò–≤–∞–Ω',5],
        ['Team Alpha','–ê–Ω–Ω–∞',7],
        ['Team Beta','–ü—ë—Ç—Ä',4],
        ['Team Beta','–û–ª—å–≥–∞',8]
      ];
      const rows = toObjects(sample);
      render(rows);
    }
  }

  load();
  setInterval(load, CONFIG.POLL_MS);
  </script>
</body>
</html>
